# Схема работы приложения

# 🎮🔐 СХЕМА РАБОТЫ ПРИЛОЖЕНИЯ С SSL-ШИФРОВАНИЕM

┌──────────────────────────────────────────────────────────────────────────────┐
│                        ИГРОВОЕ ПРИЛОЖЕНИЕ                                    │
│                                                                              │
│  ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐       │
│  │    КЛИЕНТ       │      │   СЕТЕВОЙ       │      │     СЕРВЕР      │       │
│  │  (Подключается) │      │    МОДУЛЬ       │      │  (Ожидает       │       │
│  │                 │      │  с SSL          │      │  подключения)   │       │
│  └─────────────────┘      └─────────────────┘      └─────────────────┘       │
└──────────────────────────────────────────────────────────────────────────────┘

# 🔄 ОБЩАЯ СХЕМА ВЗАИМОДЕЙСТВИЯ

┌──────────────────────────────────────────────────────────────────────────────┐
│                               КЛИЕНТ                                         │
│                                                                              │
│ 1. network_init()          ┌──────────────┐                                  │
│    │                       │ ИНИЦИАЛИЗАЦИЯ│                                  │
│    ├──────────────────────►│   OpenSSL    │                                  │
│    │                       │   библиотеки │                                  │
│    │ 2. create_ssl_context() ─────────────┘                                  │
│    │                       ┌──────────────┐                                  │
│    ├──────────────────────►│ Создание     │                                  │
│    │                       │ SSL_CTX      │                                  │
│    │                       │ (фабрика     │                                  │
│    │                       │  замков)     │                                  │
│    │                       └──────────────┘                                  │
│                                                                              │
│ 3. network_connect_to_peer()                                                 │
│    │                       ┌──────────────┐      ┌─────────────────┐         │
│    ├───TCP подключение────►│ Установка    │─────►│    СЕРВЕР       │        │
│    │                       │ TCP-соединения│     │  ожидает на     │         │
│    │                       └──────────────┘      │  порту 8080     │         │
│    │                                             └─────────────────┘         │
│    │                       ┌─────────────────────────────────┐               │
│    ├───SSL handshake──────►│ SSL-рукопожатие:                │               │
│    │                       │ • Negotiate cipher suite        │               │
│    │                       │ • Key exchange                  │               │
│    │                       │ • Establish secure channel      │               │
│    │                       └─────────────────────────────────┘               │
│                                                                              │
│ 4. ИГРОВОЙ ЦИКЛ:                                                             │
│    │                       ┌──────────────┐      ┌─────────────────┐         │
│    ├───game_state───────►│ SSL_encrypt() │─────►│  Отправка по    │         │
│    │                       │ ШИФРОВАНИЕ    │     │   сети (зашифр.)│         │
│    │                       └──────────────┘     └─────────────────┘          │
│    │                                                                         │
│    │                       ┌──────────────┐      ┌─────────────────┐         │
│    │◄──game_state───────│ SSL_decrypt() │◄─────│ Получение по    │          │
│    │                       │ РАСШИФРОВКА   │     │   сети (зашифр.)│         │
│    │                       └──────────────┘     └─────────────────┘          │
│                                                                              │
│ 5. network_cleanup()                                                         │
│    │                       ┌──────────────┐                                  │
│    ├──────────────────────►│ Закрытие     │                                  │
│    │                       │ SSL сессии   │                                  │
│    │                       └──────────────┘                                  │
│    │                       ┌──────────────┐                                  │
│    ├──────────────────────►│ Очистка      │                                  │
│    │                       │ OpenSSL      │                                  │
│    │                       └──────────────┘                                  │
└──────────────────────────────────────────────────────────────────────────────┘

# 🛠️ ПОДРОБНАЯ СХЕМА ИНИЦИАЛИЗАЦИИ

┌──────────────────────────────────────────────────────────────────────────────┐
│                          ПРОЦЕСС ИНИЦИАЛИЗАЦИИ                               │
│                                                                              │
│  КЛИЕНТ/СЕРВЕР           OPENSSL БИБЛИОТЕКА          СЕТЕВЫЕ РЕСУРСЫ         │
│                                                                              │
│  network_init()                                                              │
│      │                                                                       │
│      ├───1. init_openssl()───►                                               │
│      │                       │ OpenSSL_add_all_algorithms()                  │
│      │                       │ SSL_load_error_strings()                      │
│      │                       │ SSL_library_init()                            │
│      │                       │                                               │
│      │◄───возврат OK─────────│                                               │
│      │                                                                       │
│      ├───2. create_ssl_context()───►                                         │
│      │                       │ TLS_server/client_method()                    │
│      │                       │ SSL_CTX_new()                                 │
│      │                       │                                               │
│      │◄───SSL_CTX*───────────│                                               │
│      │                                                                       │
│      ├───3. Инициализация─────┐                                              │
│      │   сетевых сокетов      │ socket()                                     │
│      │                       │ bind() (для сервера)                          │
│      │                       │ listen() (для сервера)                        │
│      │                       └──────────────────────────────────────────────┘|
│      │                                                                       │
└──────────────────────────────────────────────────────────────────────────────┘

# 🤝 ПОДРОБНАЯ СХЕМА SSL-РУKOPOЖАТИЯ

┌──────────────────────────────────────────────────────────────────────────────┐
│                          SSL HANDSHAKE PROCESS                               │
│                                                                              │
│   КЛИЕНТ                       СЕРВЕР                       ДЕЙСТВИЕ         │
│                                                                              │
│   SSL_connect()              SSL_accept()                                    │
│      │                         │                                             │
│      │─Client Hello───────────►│                            • Cipher suites  │
│      │                         │                            • Random number  │
│      │                         │                                             │
│      │◄─Server Hello───────────│                            • Chosen cipher  │
│      │◄─Certificate────────────│                            • Server cert    │
│      │◄─Server Hello Done─────│                                              │
│      │                         │                                             │
│      │─Client Key Exchange───►│                            • Pre-master      │
│      │                         │                              secret         │
│      │                         │                                             │
│      │─Change Cipher Spec────►│                            • Switch to       │
│      │                         │                              encrypted      │
│      │                         │                                             │
│      │─Encrypted Handshake───►│                            • Verify          │
│      │                         │                                             │
│      │                         │─Change Cipher Spec───────►│ • Switch to     │
│      │                         │                            │   encrypted    │
│      │                         │                            │                │
│      │                         │─Encrypted Handshake───────►│ • Verify       │
│      │                         │                            │                │
│      │◄────────────────────────│                            • HANDSHAKE      │
│      │                         │                              COMPLETE       │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

# 🗂️ СХЕМА СТРУКТУРЫ ДАННЫХ

┌──────────────────────────────────────────────────────────────────────────────┐
│                    СТРУКТУРА NETWORK_CONTEXT_T                               │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                     network_context_t                                  │  │
│  │                                                                        │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │  │
│  │  │ listening_   │  │ connected_   │  │ is_server_   │  │ game_ready  │ │  │
│  │  │ socket       │  │ socket       │  │ mode         │  │             │ │  │
│  │  │ (int)        │  │ (int)        │  │ (int)        │  │ (int)       │ │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘ │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │                        ssl_ctx                                   │  │  │
│  │  │                       (SSL_CTX*)                                 │  │  │
│  │  │                                                                  │  │  │
│  │  │  ┌────────────────────────────────────────────────────────────┐  │  │  │
│  │  │  │                  SSL Context                               │  │  │  │
│  │  │  │  • Cipher settings                                         │  │  │  │
│  │  │  │  • Certificate store                                       │  │  │  │
│  │  │  │  • SSL/TLS configuration                                   │  │  │  │
│  │  │  └────────────────────────────────────────────────────────────┘  │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │                           ssl                                    │  │  │
│  │  │                          (SSL*)                                  │  │  │
│  │  │                                                                  │  │  │
│  │  │  ┌────────────────────────────────────────────────────────────┐  │  │  │
│  │  │  │                   SSL Session                              │  │  │  │
│  │  │  │  • Encryption keys                                         │  │  │  │
│  │  │  │  • Session state                                           │  │  │  │
│  │  │  │  • Read/write buffers                                      │  │  │  │
│  │  │  └────────────────────────────────────────────────────────────┘  │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

# ⚠️ СХЕМА ОБРАБОТКИ ОШИБОК И ОЧИСТКИ

┌──────────────────────────────────────────────────────────────────────────────┐
│                    ПРОЦЕСС ЗАВЕРШЕНИЯ РАБОТЫ                                 │
│                                                                              │
│  network_cleanup()                                                           │
│      │                                                                       │
│      ├───Если ssl существует───►                                             │
│      │                       │ SSL_shutdown()                                │
│      │                       │ • Send close_notify                           │
│      │                       │ • Clean session state                         │
│      │                       │                                               │
│      │                       │ SSL_free()                                    │
│      │                       │ • Free memory                                 │
│      │                       │                                               │
│      ├───Закрытие сокетов───►                                                │
│      │                       │ close(connected_socket)                       │
│      │                       │ close(listening_socket)                       │
│      │                       │                                               │
│      ├───Если ssl_ctx существует──►                                          │
│      │                       │ SSL_CTX_free()                                │
│      │                       │ • Free context memory                         │
│      │                       │                                               │
│      ├───Очистка OpenSSL────►                                                │
│      │                       │ EVP_cleanup()                                 │
│      │                       │ • Clean global state                          │
│      │                       │                                               │
│      └───────────────────────│                                               │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

# 🎯 ВИЗУАЛИЗАЦИЯ ПОТОКОВ ДАННЫХ

┌──────────────────────────────────────────────────────────────────────────────┐
│                    ДВУСТОРОННИЙ ОБМЕН ДАННЫМИ                                │
│                                                                              │
│   КЛИЕНТ                             СЕРВЕР                                  │
│                                                                              │
│   ┌──────────────┐                 ┌──────────────┐                          │
│   │  Игровой     │                 │  Игровой     │                          │
│   │   цикл       │                 │   цикл       │                          │
│   └──────┬───────┘                 └──────┬───────┘                          │
│          │                                │                                  │
│   ┌──────┴───────┐                 ┌──────┴───────┐                          │
│   │  SSL_write() │                 │  SSL_write() │                          │
│   │  (шифрование)│                 │  (шифрование)│                          │
│   └──────┬───────┘                 └──────┬───────┘                          │
│          │                                │                                  │
│   ┌──────┴───────┐    ЗАШИФРОВАННЫЕ   ┌──────┴───────┐                       │
│   │  send()      │─────ДАННЫНЫЕ──────►│  recv()      │                       │
│   │  (отправка)  │◄───────────────────│  (прием)     │                       │
│   └──────┬───────┘                    └──────┬───────┘                       │
│          │                                │                                  │
│   ┌──────┴───────┐                 ┌──────┴───────┐                          │
│   │  SSL_read()  │                 │  SSL_read()  │                          │
│   │(расшифровка) │                 │(расшифровка) │                          │
│   └──────┬───────┘                 └──────┬───────┘                          │
│          │                                │                                  │
│   ┌──────┴───────┐                 ┌──────┴───────┐                          │
│   │  Обработка   │                 │  Обработка   │                          │
│   │  game_state  │                 │  game_state  │                          │
│   └──────────────┘                 └──────────────┘                          │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
