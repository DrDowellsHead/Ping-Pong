# üîê –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–≥–æ –∫–æ–¥–∞ —Å SSL-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º –¥–ª—è –∏–≥—Ä—ã

## üéØ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1.  –ß—Ç–æ —Ç–∞–∫–æ–µ SSL/TLS –∏ –∑–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?
2.  –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã OpenSSL
3.  –°—Ç—Ä—É–∫—Ç—É—Ä–∞ network_context_t (—Å SSL)
4.  –§—É–Ω–∫—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenSSL
5.  –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å SSL
6.  –ü—Ä–æ—Ü–µ—Å—Å SSL-—Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è (Handshake)
7.  –ö–∞–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏
8.  –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–±–æ—Ä–∫–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

## üìñ 1. –ß—Ç–æ —Ç–∞–∫–æ–µ SSL/TLS? –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∞–ª–æ–≥–∏—è

–†–∞–Ω—å—à–µ –≤–∞—à–∏ –∏–≥—Ä–æ–∫–∏ –æ–±—â–∞–ª–∏—Å—å –ø–æ –Ω–µ–∑–∞—â–∏—â–µ–Ω–Ω–æ–º—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—é ‚Äî —ç—Ç–æ –∫–∞–∫ –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å **–æ—Ç–∫—Ä—ã—Ç–∫–∏**. –õ—é–±–æ–π –ø–æ—á—Ç–∞–ª—å–æ–Ω (–ø—Ä–æ–≤–∞–π–¥–µ—Ä, —Ö–∞–∫–µ—Ä –≤ —Å–µ—Ç–∏) –º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.

**SSL/TLS** ‚Äî —ç—Ç–æ **–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω–≤–µ—Ä—Ç —Å —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –∑–∞–º–∫–æ–º**:
-   **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:** –°–æ–æ–±—â–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ
-   **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ª–∏—á–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
-   **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:** –ì–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ

## üîë 2. –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã OpenSSL

-   **OpenSSL** ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, —Ä–µ–∞–ª–∏–∑—É—é—â–∞—è SSL/TLS
-   **SSL_CTX (SSL Context)** ‚Äî "—Ñ–∞–±—Ä–∏–∫–∞ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É –∑–∞–º–∫–æ–≤" (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
-   **SSL (SSL Session)** ‚Äî "–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–º–æ–∫" –Ω–∞ –æ–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
-   **SSL Handshake** ‚Äî "—Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ": –ø—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

## üèóÔ∏è 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ network_context_t (—Å SSL)

```c
typedef struct {
    int listening_socket;  // –°–æ–∫–µ—Ç –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è (–∫–∞–∫ "—Ç–µ–ª–µ—Ñ–æ–Ω")
    int connected_socket;  // –°–æ–∫–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–∫–∞–∫ "—Ç—Ä—É–±–∫–∞")
    int is_server_mode;    // 1 = —Å–µ—Ä–≤–µ—Ä, 0 = –∫–ª–∏–µ–Ω—Ç
    int game_ready;        // 1 = —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
    SSL_CTX *ssl_ctx;      // –§–∞–±—Ä–∏–∫–∞ SSL-–∑–∞–º–∫–æ–≤ (–∫–æ–Ω—Ç–µ–∫—Å—Ç)
    SSL *ssl;              // –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π SSL-–∑–∞–º–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
} network_context_t;
```

# ‚öôÔ∏è 4. –§—É–Ω–∫—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenSSL
**network_ssl.h**

```c
#ifndef NETWORK_SSL_H
#define NETWORK_SSL_H

#include <openssl/err.h> // –§—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ OpenSSL
#include <openssl/ssl.h> // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ SSL/TLS
#include <stdlib.h>

#include "game.h"

#define PORT 8080         // –ù–æ–º–µ—Ä –ø–æ—Ä—Ç–∞ –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
#define BUFFER_SIZE 1024  // –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
#define MAX_IP_LENGTH 16  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ IP-–∞–¥—Ä–µ—Å–∞

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Ç–µ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å SSL
typedef struct {
    int listening_socket;  // –°–æ–∫–µ—Ç –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    int connected_socket;  // –°–æ–∫–µ—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    int is_server_mode;    // –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: 1-—Å–µ—Ä–≤–µ—Ä, 0-–∫–ª–∏–µ–Ω—Ç
    int game_ready;        // –§–ª–∞–≥ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: 1-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
    SSL_CTX *ssl_ctx;      // –ö–æ–Ω—Ç–µ–∫—Å—Ç SSL (—Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è)
    SSL *ssl;              // SSL —Å–µ—Å—Å–∏—è (–¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
} network_context_t;

// –ü—Ä–æ—Ç–æ—Ç–∏–ø—ã —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SSL
int init_openssl();                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ OpenSSL
SSL_CTX *create_ssl_context();         // –°–æ–∑–¥–∞–Ω–∏–µ SSL –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
void cleanup_openssl();                // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ OpenSSL

// –ü—Ä–æ—Ç–æ—Ç–∏–ø—ã —Å–µ—Ç–µ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
void network_init(network_context_t *ctx);                 // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
void network_get_local_ip(char *buffer, size_t buffer_size); // –ü–æ–ª—É—á–µ–Ω–∏–µ IP
void network_start_listener(network_context_t *ctx);       // –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
void network_connect_to_peer(network_context_t *ctx,       // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                             const char *peer_ip);         
void network_send_game_state(const network_context_t *ctx, // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                             const game_state_t *state);    
int network_receive_game_state(const network_context_t *ctx, // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                               game_state_t *state);        
void network_cleanup(network_context_t *ctx);              // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

#endif
```

**network_ssl.c (—á–∞—Å—Ç—å 1 - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)**

```c
#include "network_ssl.h"
#include <arpa/inet.h>
#include <netdb.h>
#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <unistd.h>

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ OpenSSL (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
int init_openssl() {
    OpenSSL_add_all_algorithms();  // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
    SSL_load_error_strings();      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–æ–∫ –æ—à–∏–±–æ–∫ SSL
    return SSL_library_init();     // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ SSL
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–±—Ä–∏–∫–∏ SSL-–∑–∞–º–∫–æ–≤ (SSL Context)
SSL_CTX *create_ssl_context() {
    const SSL_METHOD *method; // –ú–µ—Ç–æ–¥ (–ø—Ä–æ—Ç–æ–∫–æ–ª) —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
    SSL_CTX *ctx;             // –ö–æ–Ω—Ç–µ–∫—Å—Ç SSL (—Ñ–∞–±—Ä–∏–∫–∞ –∑–∞–º–∫–æ–≤)

    // –í—ã–±–∏—Ä–∞–µ–º –º–µ—Ç–æ–¥ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è - TLS –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
    method = TLS_server_method(); // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞

    // –°–æ–∑–¥–∞–µ–º —Å–∞–º –∫–æ–Ω—Ç–µ–∫—Å—Ç SSL (—Å—Ç—Ä–æ–∏–º —Ñ–∞–±—Ä–∏–∫—É –∑–∞–º–∫–æ–≤)
    ctx = SSL_CTX_new(method);
    if (!ctx) {
        perror("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å SSL –∫–æ–Ω—Ç–µ–∫—Å—Ç");
        ERR_print_errors_fp(stderr); // –ü–µ—á–∞—Ç—å –æ—à–∏–±–æ–∫ OpenSSL
        exit(EXIT_FAILURE);
    }

    return ctx; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—É—é —Ñ–∞–±—Ä–∏–∫—É SSL-–∑–∞–º–∫–æ–≤
}

// –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ OpenSSL (—É–±–æ—Ä–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
void cleanup_openssl() {
    EVP_cleanup(); // –í—ã–≥—Ä—É–∑–∫–∞ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –∏–∑ –ø–∞–º—è—Ç–∏
}
```

# üîß 5. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å SSL
**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∏ —Å SSL**

```c
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–µ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π SSL
void network_init(network_context_t *ctx) {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—ã—á–Ω—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö –ø–æ–ª–µ–π
    ctx->listening_socket = -1;  // -1 = "—Å–æ–∫–µ—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
    ctx->connected_socket = -1;  // -1 = "—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    ctx->is_server_mode = 0;     // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–µ–∂–∏–º –∫–ª–∏–µ–Ω—Ç–∞
    ctx->game_ready = 0;         // –ò–≥—Ä–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞ –∫ –Ω–∞—á–∞–ª—É

    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø OPENSSL
    if (!init_openssl()) {
        fprintf(stderr, "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenSSL\n");
        exit(EXIT_FAILURE);
    }

    // –°–û–ó–î–ê–ù–ò–ï SSL –ö–û–ù–¢–ï–ö–°–¢–ê (—Ñ–∞–±—Ä–∏–∫–∏ –∑–∞–º–∫–æ–≤)
    ctx->ssl_ctx = create_ssl_context();
    ctx->ssl = NULL; // –ü–æ–∫–∞ SSL —Å–µ—Å—Å–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω–∞
}
```

**–§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ —Å SSL**

```c
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Ç–æ–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —Å SSL
static void *listener_thread(void *arg) {
    network_context_t *ctx = (network_context_t *)arg;
    struct sockaddr_in address;
    int opt = 1;
    int addrlen = sizeof(address);

    // –°–û–ó–î–ê–ù–ò–ï –ò –ù–ê–°–¢–†–û–ô–ö–ê –°–û–ö–ï–¢–ê (–∫–∞–∫ –≤ –æ–±—ã—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏)
    if ((ctx->listening_socket = socket(AF_INET, SOCK_STREAM, 0)) == 0) {
        perror("socket failed");
        exit(EXIT_FAILURE);
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–∫–µ—Ç–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–∞
    if (setsockopt(ctx->listening_socket, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt))) {
        perror("setsockopt");
        close(ctx->listening_socket);
        exit(EXIT_FAILURE);
    }

    // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–∫–µ—Ç–∞ –∫ –∞–¥—Ä–µ—Å—É –∏ –ø–æ—Ä—Ç—É
    address.sin_family = AF_INET;
    address.sin_addr.s_addr = INADDR_ANY;
    address.sin_port = htons(PORT);

    if (bind(ctx->listening_socket, (struct sockaddr *)&address, sizeof(address)) < 0) {
        perror("bind failed");
        close(ctx->listening_socket);
        exit(EXIT_FAILURE);
    }

    // –ù–∞—á–∞–ª–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    if (listen(ctx->listening_socket, 3) < 0) {
        perror("listen");
        close(ctx->listening_socket);
        exit(EXIT_FAILURE);
    }

    // –ü—Ä–∏–Ω—è—Ç–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    if ((ctx->connected_socket = accept(ctx->listening_socket, 
                                      (struct sockaddr *)&address,
                                      (socklen_t *)&addrlen)) < 0) {
        perror("accept");
        close(ctx->listening_socket);
        exit(EXIT_FAILURE);
    }

    // ##### –ù–ê–ß–ê–õ–û SSL-–ú–ê–ì–ò–ò #####
    // –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ô SSL –°–ï–°–°–ò–ò (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–º–æ–∫)
    ctx->ssl = SSL_new(ctx->ssl_ctx);

    // –ü–†–ò–í–Ø–ó–ö–ê SSL –°–ï–°–°–ò–ò –ö –°–û–ö–ï–¢–£ (–≤–µ—à–∞–µ–º –∑–∞–º–æ–∫ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—É—é —Ç—Ä—É–±–∫—É)
    SSL_set_fd(ctx->ssl, ctx->connected_socket);

    // –í–´–ü–û–õ–ù–ï–ù–ò–ï SSL-–†–£–ö–û–ü–û–ñ–ê–¢–ò–Ø (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
    // –°–µ—Ä–≤–µ—Ä–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞: –ø—Ä–∏–Ω–∏–º–∞–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º handshake
    if (SSL_accept(ctx->ssl) <= 0) {
        // –ï—Å–ª–∏ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å - –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫–∏
        ERR_print_errors_fp(stderr);
        close(ctx->connected_socket);
        close(ctx->listening_socket);
        exit(EXIT_FAILURE);
    }
    // ##### SSL-–°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û #####

    ctx->is_server_mode = 1;
    ctx->game_ready = 1; // –ò–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ –Ω–∞—á–∞–ª—É (—Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º!)

    return NULL;
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞—é—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞
void network_start_listener(network_context_t *ctx) {
    pthread_t thread_id;
    pthread_create(&thread_id, NULL, listener_thread, ctx);
    pthread_detach(thread_id);
}
```
**–§—É–Ω–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ —Å SSL**

```c
// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –¥—Ä—É–≥–æ–º—É –ø–∏—Ä—É —Å SSL
void network_connect_to_peer(network_context_t *ctx, const char *peer_ip) {
    struct sockaddr_in serv_addr;

    // –°–û–ó–î–ê–ù–ò–ï –°–û–ö–ï–¢–ê (–∫–∞–∫ –≤ –æ–±—ã—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏)
    if ((ctx->connected_socket = socket(AF_INET, SOCK_STREAM, 0)) < 0) {
        printf("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–∫–µ—Ç–∞");
        exit(EXIT_FAILURE);
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∞–¥—Ä–µ—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞
    serv_addr.sin_family = AF_INET;
    serv_addr.sin_port = htons(PORT);

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ IP –≤ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    if (inet_pton(AF_INET, peer_ip, &serv_addr.sin_addr) <= 0) {
        printf("\n–ù–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å: %s", peer_ip);
        close(ctx->connected_socket);
        exit(EXIT_FAILURE);
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    if (connect(ctx->connected_socket, (struct sockaddr *)&serv_addr,
                sizeof(serv_addr)) < 0) {
        printf("\n–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ %s", peer_ip);
        close(ctx->connected_socket);
        exit(EXIT_FAILURE);
    }

    // ##### –ù–ê–ß–ê–õ–û SSL-–ú–ê–ì–ò–ò –ù–ê –ö–õ–ò–ï–ù–¢–ï #####
    // –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ô SSL –°–ï–°–°–ò–ò (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–º–æ–∫)
    ctx->ssl = SSL_new(ctx->ssl_ctx);

    // –ü–†–ò–í–Ø–ó–ö–ê SSL –°–ï–°–°–ò–ò –ö –°–û–ö–ï–¢–£
    SSL_set_fd(ctx->ssl, ctx->connected_socket);

    // –í–´–ü–û–õ–ù–ï–ù–ò–ï SSL-–†–£–ö–û–ü–û–ñ–ê–¢–ò–Ø (–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)
    // –ö–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç handshake —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    if (SSL_connect(ctx->ssl) <= 0) {
        ERR_print_errors_fp(stderr);
        close(ctx->connected_socket);
        exit(EXIT_FAILURE);
    }
    // ##### SSL-–°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û #####

    ctx->game_ready = 1; // –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏ –∑–∞—â–∏—â–µ–Ω–æ!
}
```

**–§—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å SSL**

```c
// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã —á–µ—Ä–µ–∑ –∑–∞—â–∏—â–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
void network_send_game_state(const network_context_t *ctx,
                             const game_state_t *state) {
    char buffer[BUFFER_SIZE];

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã –≤ —Å—Ç—Ä–æ–∫—É
    snprintf(buffer, BUFFER_SIZE, "%d, %d, %d, %d, %d, %d, %d", 
             state->lRacketY, state->rRacketY, state->ballX, 
             state->ballY, state->lScore, state->rScore, state->command);

    // –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –ß–ï–†–ï–ó SSL
    // SSL_write –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –®–ò–§–†–£–ï–¢ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    SSL_write(ctx->ssl, buffer, strlen(buffer));
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã —á–µ—Ä–µ–∑ –∑–∞—â–∏—â–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
int network_receive_game_state(const network_context_t *ctx,
                               game_state_t *state) {
    char buffer[BUFFER_SIZE] = {0};

    // –ß–¢–ï–ù–ò–ï –î–ê–ù–ù–´–• –ß–ï–†–ï–ó SSL
    // SSL_read –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –†–ê–°–®–ò–§–†–û–í–´–í–ê–ï–¢ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    int bytes_received = SSL_read(ctx->ssl, buffer, BUFFER_SIZE - 1);

    if (bytes_received > 0) {
        buffer[bytes_received] = '\0';
        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ—Å—Ç–æ—è–Ω–∏—è
        sscanf(buffer, "%d, %d, %d, %d, %d, %d, %d", 
               &state->lRacketY, &state->rRacketY, &state->ballX, 
               &state->ballY, &state->lScore, &state->rScore, &state->command);
        return 1; // –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã
    }
    return 0; // –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
}
```

**–§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å SSL**

```c
// –û—á–∏—Å—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –∏ SSL —Ä–µ—Å—É—Ä—Å–æ–≤
void network_cleanup(network_context_t *ctx) {
    // –ó–∞–∫—Ä—ã—Ç–∏–µ SSL —Å–µ—Å—Å–∏–∏ (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è)
    if (ctx->ssl) {
        SSL_shutdown(ctx->ssl); // –í–µ–∂–ª–∏–≤–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ SSL —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        SSL_free(ctx->ssl);     // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ SSL —Å–µ—Å—Å–∏–∏
        ctx->ssl = NULL;
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–∫–µ—Ç–æ–≤
    if (ctx->connected_socket >= 0)
        close(ctx->connected_socket);
    if (ctx->listening_socket >= 0)
        close(ctx->listening_socket);

    // –û—á–∏—Å—Ç–∫–∞ SSL –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    if (ctx->ssl_ctx) {
        SSL_CTX_free(ctx->ssl_ctx);
        ctx->ssl_ctx = NULL;
    }

    // –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ OpenSSL
    cleanup_openssl();
}
```

**ü§ù 6. –ü—Ä–æ—Ü–µ—Å—Å SSL-—Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è (Handshake)**

–ö–ª–∏–µ–Ω—Ç                 –°–µ—Ä–≤–µ—Ä
   |                     |
   |--- Client Hello --->|  ‚Ä¢ –ö–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –º–µ—Ç–æ–¥—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
   |                     |  ‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ
   |                     |
   |<-- Server Hello ----|  ‚Ä¢ –°–µ—Ä–≤–µ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç –º–µ—Ç–æ–¥ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
   |<-- Certificate -----|  ‚Ä¢ –°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
   |<-- Server Done -----|  ‚Ä¢ –°–µ—Ä–≤–µ—Ä –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–≤–æ—é —á–∞—Å—Ç—å
   |                     |
   |--- Client Key ----> |  ‚Ä¢ –ö–ª–∏–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á —Å–µ—Å—Å–∏–∏
   |    Exchange         |  ‚Ä¢ –®–∏—Ñ—Ä—É–µ—Ç –µ–≥–æ –ø—É–±–ª–∏—á–Ω—ã–º –∫–ª—é—á–æ–º —Å–µ—Ä–≤–µ—Ä–∞
   |                     |
   |--- Change Cipher -->|  ‚Ä¢ –ö–ª–∏–µ–Ω—Ç: "–¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ!"
   |       Spec          |
   |                     |
   |<-- Change Cipher ---|  ‚Ä¢ –°–µ—Ä–≤–µ—Ä: "–°–æ–≥–ª–∞—Å–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ!"
   |       Spec          |
   |                     |
   |--- Encrypted ------>|  ‚Ä¢ –ü–µ—Ä–≤–æ–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
   |      Handshake      |
   |                     |
   |<-- Encrypted ------ |  ‚Ä¢ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π)
   |      Handshake      |
   |                     |
   |== Secure Channel == |  ‚Ä¢ –ö–∞–Ω–∞–ª –∑–∞—â–∏—â–µ–Ω, –º–æ–∂–Ω–æ –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è –¥–∞–Ω–Ω—ã–º–∏
   
   
# üîÑ 7. –ö–∞–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏
1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:

    - –û–±—ã—á–Ω–æ–µ TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)

    - SSL-—Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –ø–æ–≤–µ—Ä—Ö TCP

    - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞

2. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:

    - SSL_write() –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —à–∏—Ñ—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ

    - –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–æ —Å–µ—Ç–∏

    - –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ "–º—É—Å–æ—Ä"

3. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:

    - SSL_read() –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

    - –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —á–∏—Å—Ç—ã–µ, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
